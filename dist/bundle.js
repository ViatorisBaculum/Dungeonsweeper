(()=>{"use strict";const e={typeDistribution:{Rat:.4,Zombie:.3,Skeleton:.1,Ghost:.1,Witch:.1,Boss:0},expToNextLevel:[100,200,300,400],boardDefaults:{width:40,height:20,minesFrequency:.3,evolutionRate:.2,invertClicks:!1,removeFlags:!1},playerClass:"Warrior",monsterKeys:{0:"E",1:"R¬π",2:"Z¬≤",3:"S¬≥",4:"G‚Å¥",5:"W‚Åµ",6:"B‚Å∂"},experienceGain:{open:1,multiplicator:3},revealDelayPerCell:40};class t{constructor(){this._experience=0,this._health=0,this.maxHealth=0,this._level=1,this._score=0,this.heartContainers=[],this._HTMLHooks=this.loadHTMLHooks()}set experience(e){this._experience=e,this.gainLevel(),this.updateStatsheet()}get experience(){return this._experience}set health(e){this._health=e,this._health<=0&&d.getInstance().loseGame(),this.updateStatsheet()}get health(){return this._health}set level(e){this._level=e,this.updateStatsheet()}get level(){return this._level}set score(e){this._score=e,this.updateStatsheet()}get score(){return this._score}calculateScore(e){this.score=this.experience-e,this.score<0&&(this.score=0)}getAttacked(e){this.health-=e}gainExperience(e){this.experience+=e,console.log("exp",this.experience)}debugSetExperience(e){if(e<0)throw new Error("Experience cannot be negative");this.experience=e}debugGainLevel(){this.level<=4&&(this.level+=1),this.experience=e.expToNextLevel[this.level-1],this.updateStatsheet(),d.getInstance().playerUp()}createMemento(){const e={className:this.className,experience:this.experience,health:this.health,maxHealth:this.maxHealth,level:this.level,score:this.score};return"Mage"===this.className&&(e.fireballAvailable=this.canCastFireball()),e}restoreFromMemento(e){if(this._experience=e.experience,this.maxHealth=e.maxHealth,this._health=e.health,this._level=e.level,this._score=e.score,"Mage"===this.className&&void 0!==e.fireballAvailable){const t=this;e.fireballAvailable?t.resetFireball():(t.activateFireballMode(),t.castFireballOnCell(-10,-10))}this.updateStatsheet()}gainLevel(){this.experience>e.expToNextLevel[this.level-1]&&(this.level+=1,d.getInstance().playerUp(),"Warrior"===this.className&&this.gainHealth())}gainHealth(){this.health<this.maxHealth&&(this.health+=1,this.styleHearts())}importHTMLElement(e){const t=document.getElementById(e);if(!t)throw new Error("No html element with id: "+e);return t}importHTMLProgressElement(e){const t=document.getElementById(e);if(!t)throw new Error("No html element with id: "+e);return t}loadHTMLHooks(){return{playerClassSpan:this.importHTMLElement("playerClass"),playerExperienceProgress:this.importHTMLProgressElement("experience"),playerHealthDiv:this.importHTMLElement("health"),playerLevelDiv:this.importHTMLElement("playerLevel"),playerScoreDiv:this.importHTMLElement("score")}}updateStatsheet(){this._HTMLHooks.playerClassSpan.innerText=this.className,this._HTMLHooks.playerLevelDiv.innerText=this._level.toString(),0===this.heartContainers.length&&this.addHearts(),this.styleHearts(),this.updateProgress(),this._HTMLHooks.playerScoreDiv.innerText="Score: "+this._score.toString()}addHearts(){for(let e=0;e<this.maxHealth;e++){const e=document.createElement("img");e.src="./res/heart.svg",e.alt="Health",e.classList.add("heart"),this.heartContainers.push(e),this._HTMLHooks.playerHealthDiv.appendChild(e)}}styleHearts(){this.heartContainers.forEach(((e,t)=>{t>=this.health?e.classList.add("colored"):e.classList.remove("colored")}))}updateProgress(){if(this._level<5){const t=this._level>1?e.expToNextLevel[this.level-2]:0;this._HTMLHooks.playerExperienceProgress.max=e.expToNextLevel[this.level-1]-t,this._HTMLHooks.playerExperienceProgress.value=this._experience-t}}}class s extends t{constructor(e){super(),this.className="Assassin",this.health=2,this.maxHealth=this.health}}var i;!function(e){e[e.Empty=0]="Empty",e[e.Rat=1]="Rat",e[e.Zombie=2]="Zombie",e[e.Skeleton=3]="Skeleton",e[e.Ghost=4]="Ghost",e[e.Witch=5]="Witch",e[e.Boss=6]="Boss"}(i||(i={}));class a extends t{constructor(e){if(super(),this.className="Mage",this.fireballAvailable=!0,this.isFireballModeActive=!1,!e)throw new Error("PC_Mage requires a Board instance during construction.");this.health=2,this.maxHealth=this.health,this.board=e}canCastFireball(){return this.fireballAvailable}consumeFireballCharge(){this.fireballAvailable=!1}resetFireball(){this.fireballAvailable=!0,M()}activateFireballMode(){return!!this.canCastFireball()&&(this.isFireballModeActive=!0,document.body.classList.add("fireball-mode-active"),M(),!0)}deactivateFireballMode(){this.isFireballModeActive=!1,document.body.classList.remove("fireball-mode-active"),M()}castFireballOnCell(e,t){if(this.isFireballModeActive){for(let s=-1;s<=1;s++)for(let a=-1;a<=1;a++){const l=this.board.getCell(e+s,t+a);l&&!l.isClicked&&l.type===i.Empty&&l.click(0)}this.consumeFireballCharge(),this.deactivateFireballMode()}}}class l extends t{constructor(e){super(),this.className="Paladin",this.health=4,this.maxHealth=this.health}}class n extends t{constructor(e){super(),this.className="Warrior",this.health=3,this.maxHealth=this.health}}class r{constructor(e,t,s,i,a,l,n){this.isClicked=!1,this.isFlagged=!1,this.type=e,this.board=t,this.x=s,this.y=i,this.HTMLElement=a,this.gameInstance=l,this.value=n}createMemento(){return{type:this.type,value:this.value,isClicked:this.isClicked,isFlagged:this.isFlagged}}restoreFromMemento(e){this.type=e.type,this.value=e.value,this.isClicked=e.isClicked,this.isFlagged=e.isFlagged}activateCell(e){this.revealCell(),this.addExperience(e)}addExperience(e){this.gameInstance.player.gainExperience(e)}attackPlayer(t){this.type!==i.Empty&&(console.log("Monster attack! Type:",this.type,"at",this.x,this.y),"Assassin"===this.gameInstance.player.className&&this.type===i.Boss&&void 0===t&&(t=1),t||0===t||(t=this.type-this.gameInstance.player.level+1),t>0&&this.gameInstance.player.getAttacked(t),this.addExperience(this.type*e.experienceGain.multiplicator),this.gameInstance.player.health>0&&this.type===i.Boss&&this.gameInstance.winGame(),this.animateDefeat())}click(t){this.isClicked||this.isFlagged||(void 0!==this.value&&this.activateCell(e.experienceGain.open),0===this.value&&this.type===i.Empty&&this.clickNeighbors(t),this.type>0&&void 0===this.value&&(this.attackPlayer(t),this.activateCell(0)))}getBlankNeighbors(){let e=[];const{x:t,y:s,board:i}=this;for(let a=-1;a<=1;a++)for(let l=-1;l<=1;l++){const n=i.getCell(t+a,s+l);n&&0===n.value&&e.push(n)}return e}static delay(e){return new Promise((t=>setTimeout(t,e)))}clickNeighbors(t){return s=this,a=void 0,n=function*(){const{x:s,y:a,board:l}=this,n=[];for(let e=-1;e<=1;e++)for(let t=-1;t<=1;t++){const i=l.getCell(s+e,a+t);!i||i.isClicked||i.isFlagged||n.push(i)}for(const s of n){if(this.gameInstance.isGameEnded())return;0===s.value?(yield r.delay(e.revealDelayPerCell),yield s.click(t)):s.type===i.Empty?(yield r.delay(e.revealDelayPerCell),s.activateCell(e.experienceGain.open)):s.type>i.Empty&&(yield r.delay(e.revealDelayPerCell),s.click(t))}},new((l=void 0)||(l=Promise))((function(e,t){function i(e){try{o(n.next(e))}catch(e){t(e)}}function r(e){try{o(n.throw(e))}catch(e){t(e)}}function o(t){var s;t.done?e(t.value):(s=t.value,s instanceof l?s:new l((function(e){e(s)}))).then(i,r)}o((n=n.apply(s,a||[])).next())}));var s,a,l,n}isAnyNeighborClicked(){const{x:e,y:t,board:s}=this;for(let i=-1;i<=1;i++)for(let a=-1;a<=1;a++){const l=s.getCell(e+i,t+a);if(l&&l.isClicked)return!0}return!1}revealCell(){this.isClicked||(this.isClicked=!0,this.animateReveal(),this.updateVisuals())}rightClick(e){e.preventDefault(),"Assassin"!==this.gameInstance.player.className?this.isClicked?this.clickNeighbors():(this.isFlagged=!this.isFlagged,this.updateVisuals()):this.rightClickAssassin(e)}rightClickAssassin(e){e.preventDefault(),this.isClicked?this.clickNeighbors():(this.activateCell(0),this.gameInstance.player.level===this.type||this.type+this.gameInstance.player.level===11?this.attackPlayer(0):this.gameInstance.player.level<this.type?this.attackPlayer():this.attackPlayer(1))}translateType(t){return t>0&&void 0!==e.monsterKeys[t]?e.monsterKeys[t]:t===i.Empty?".":"?"}updateVisuals(){if(this.isFlagged?(this.HTMLElement.innerHTML="üíÄ",this.HTMLElement.classList.add("flagged")):(this.HTMLElement.innerHTML="",this.HTMLElement.classList.remove("flagged")),this.isClicked)if(this.HTMLElement.classList.add("clicked"),this.HTMLElement.classList.add("shrinked"),this.value)this.HTMLElement.innerText=this.value.toString();else if(!this.value&&this.type>0){this.HTMLElement.innerText=this.translateType(this.type);const e=this.translateType(this.type).replace(/[^a-zA-Z0-9_-]/g,"");this.HTMLElement.classList.add("monster",e)}else this.HTMLElement.innerText="";else this.HTMLElement.classList.remove("clicked"),this.HTMLElement.classList.remove("shrinked")}animateReveal(){this.HTMLElement.checkVisibility()&&(this.HTMLElement.classList.remove("shrinked"),this.HTMLElement.classList.add("shrinked"),this.type>0&&(this.HTMLElement.classList.remove("monster-reveal-anim"),this.HTMLElement.offsetWidth,this.HTMLElement.classList.add("monster-reveal-anim")))}animateDefeat(){const e=this.HTMLElement,t=e.parentElement;if(!t)return;const s=e.offsetLeft+e.offsetWidth/2,i=e.offsetTop+e.offsetHeight/2,a=Math.min(e.offsetWidth,e.offsetHeight),l=1.1*a,n=.5*a;Array.from({length:3},((e,t)=>t)).sort((()=>Math.random()-.5)).forEach(((e,a)=>{const r=document.createElement("img");r.src="./res/star.svg",r.classList.add("defeat-star");const o=.8+.6*Math.random(),h=Math.floor(360*Math.random()),c=e/3*2*Math.PI,d=.15*l,m=Math.cos(c)*(l+(Math.random()-.5)*d),g=Math.sin(c)*(l+(Math.random()-.5)*d);r.style.setProperty("--tx",`${m}px`),r.style.setProperty("--ty",`${g}px`),r.style.setProperty("--s",`${o}`),r.style.setProperty("--r",`${h}deg`),r.style.animationDelay=.08*a+"s",r.style.left=s-n/2+"px",r.style.top=i-n/2+"px",r.style.width=`${n}px`,r.style.height=`${n}px`,t.appendChild(r),r.addEventListener("animationend",(()=>{r.remove()}))}))}}const o={saveKey:"saveGame",isGameEnded:!1,saveGame(){if(!this.isGameEnded)try{const e=window.gameInstance.createMemento();localStorage.setItem(this.saveKey,JSON.stringify(e)),console.log("Game saved.")}catch(e){console.error("Could not save game state:",e)}},loadGame(){try{const e=localStorage.getItem(this.saveKey);if(e){const t=JSON.parse(e);return console.log("Game loaded."),t}return null}catch(e){return console.error("Could not load game state:",e),this.deleteSave(),null}},deleteSave(){console.log("Deleting save file."),this.isGameEnded=!0,localStorage.removeItem(this.saveKey)},hasSave(){return null!==localStorage.getItem(this.saveKey)}};class h{constructor(t,s,i,a,l=e.typeDistribution){this.cells=[],this.validateDistribution(l),this.gameInstance=a,this._minesFrequency=i,this._width=t,this._height=s;const n=document.getElementById("app");if(!n)throw new Error("board: No #app div found");this.appElement=n,this.fillBoard(l),this.determineCellValues(),this.updateCSSVariables(t,s),this.clickHandler=this.createClickHandler(),this.contextMenuHandler=this.createContextMenuHandler(),this.addBoardEventHandlers(),this.indicateLevelGain(1)}createMemento(){return{cells:this.cells.map((e=>e.map((e=>e.createMemento()))))}}restoreFromMemento(e){for(let t=0;t<this._height;t++)for(let s=0;s<this._width;s++)this.cells[t][s].restoreFromMemento(e.cells[t][s])}redraw(){this.cells.flat().forEach((e=>e.updateVisuals()))}evoluteMonster(){this.getRemainingMonster().forEach((t=>{Math.random()<=e.boardDefaults.evolutionRate&&t.type<i.Witch&&(t.type+=1)})),this.determineCellValues(),this.debug_printCellValues()}getCell(e,t){return this.cells[e]&&this.cells[e][t]?this.cells[e][t]:void 0}getCellType(e,t){return this.getCell(e,t)?this.cells[e][t].type:i.Empty}indicateLevelGain(e){if(this.appElement){for(let e=1;e<=5;e++)this.appElement.classList.remove(`level-${e}`);this.appElement.classList.add(`level-${e}`),this.appElement.classList.remove("highlight"),this.appElement.offsetWidth,this.appElement.classList.add("highlight")}}openStartArea(){let e=Math.floor(Math.random()*(this._height-1)),t=Math.floor(Math.random()*(this._width-1)),s=this.cells[e][t];for(;0!==s.value;)e=Math.round(Math.random()*(this._height-1)),t=Math.round(Math.random()*(this._width-1)),s=this.cells[e][t];s.click(),s.HTMLElement.scrollIntoView({behavior:"smooth",block:"center",inline:"center"})}removeEventHandler(){this.appElement.removeEventListener("click",this.clickHandler),this.appElement.removeEventListener("contextmenu",this.contextMenuHandler)}removeAllFlags(){this.cells.flat().forEach((e=>{e.isFlagged&&(e.isFlagged=!1,e.updateVisuals())}))}revealBoard(){this.cells.flat().forEach((e=>{e.isClicked||(e.HTMLElement.classList.add("notClicked"),e.revealCell(),e.isFlagged&&(e.isFlagged=!1))}))}createUrn(e){const t=this._width*this._height,s=this._minesFrequency*t,a=t*(1-this._minesFrequency),l=new Array(t).fill(i.Empty,0,a-1);l.fill(i.Boss,a-1,a);const n=a+e.Rat*s,r=n+e.Zombie*s,o=r+e.Skeleton*s,h=o+e.Ghost*s,c=h+e.Witch*s,d=c+e.Boss*s;l.fill(i.Rat,a,n),l.fill(i.Zombie,n,r),l.fill(i.Skeleton,r,o),l.fill(i.Ghost,o,h),l.fill(i.Witch,h,c),l.fill(i.Boss,c,d);for(let e=l.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[l[e],l[t]]=[l[t],l[e]]}return l}determineCellValues(){this.cells.forEach(((e,t)=>{e.forEach(((e,s)=>{if(e.type===i.Empty){let i=0;i+=this.getCellType(t-1,s-1),i+=this.getCellType(t-1,s+0),i+=this.getCellType(t-1,s+1),i+=this.getCellType(t+0,s-1),i+=this.getCellType(t+0,s+1),i+=this.getCellType(t+1,s-1),i+=this.getCellType(t+1,s+0),i+=this.getCellType(t+1,s+1),e.value=i}}))}))}fillBoard(e){var t;const s=this.createUrn(e),a=document.createDocumentFragment();for(let e=0;e<this._height;e++){this.cells.push([]);for(let l=0;l<this._width;l++){const n=document.createElement("button");n.dataset.x=e.toString(),n.dataset.y=l.toString();const o=new r(null!==(t=s.pop())&&void 0!==t?t:i.Empty,this,e,l,n,this.gameInstance,void 0);a.appendChild(n),this.cells[e].push(o)}}this.appElement.appendChild(a)}getRemainingMonster(){let e=[];return this.cells.forEach((t=>{t.forEach((t=>{!t.isAnyNeighborClicked()&&t.type>i.Empty&&!t.isClicked&&e.push(t)}))})),e}updateCSSVariables(e,t){const s=document.querySelector(":root");if(!s)throw new Error("No :root found");s.style.setProperty("--cols",e.toString()),s.style.setProperty("--rows",t.toString())}validateDistribution(e){let t=0;for(const[s,i]of Object.entries(e))t+=i;if(Math.abs(t-1)<1e-6)return!0;throw new Error("Provided typeDistribution doesn't sum to 1. Sum of proportions is "+t)}createClickHandler(){return e=>{const t=e.target;if(!t||!t.dataset.x||!t.dataset.y)return;const s=Number(t.dataset.x),i=Number(t.dataset.y),a=this.getCell(s,i);if(!a)return;const l=d.getInstance(),n=l.player;if("Mage"===n.className){const t=n;if(t.isFireballModeActive)return e.preventDefault(),t.castFireballOnCell(s,i),void o.saveGame()}l.invertClicks?a.rightClick(e):a.click(),o.saveGame()}}createContextMenuHandler(){return e=>{e.preventDefault();const t=e.target;if(!t.dataset.x||!t.dataset.y)return;const s=Number(t.dataset.x),i=Number(t.dataset.y),a=this.getCell(s,i);a&&(d.getInstance().invertClicks?a.click():a.rightClick(e),o.saveGame())}}addBoardEventHandlers(){this.appElement.addEventListener("click",this.clickHandler),this.appElement.addEventListener("contextmenu",this.contextMenuHandler)}debug_printCellValues(){let e="";e+="    ";for(let t=0;t<this._width;t++)e+=t.toString().padStart(3," ");e+="\n",this.cells.forEach(((t,s)=>{let a=s.toString().padStart(3," ")+" ";t.forEach((e=>{let t=e.type===i.Empty?void 0!==e.value?e.value.toString():".":e.translateType(e.type);a+=t.toString().padStart(3," ")})),e+=a+"\n"})),console.log(e)}debug_writeValues(e){!0===e&&this.cells.forEach((e=>{e.forEach((e=>{e.type&&(e.HTMLElement.innerText=e.translateType(e.type))}))}))}setupDebugUI(){this.setupDebugToggle(this);const e="true"===localStorage.getItem("showDebug"),t=document.getElementById("debugLevelUp");t&&(t.style.display=e?"":"none"),this.debug_writeValues(e),this.debug_printCellValues()}setupDebugToggle(e){const t=document.getElementById("showDebug"),s=document.getElementById("debugLevelUp");if(!t||!s)return;const i="true"===localStorage.getItem("showDebug");t.checked=i,s.style.display=i?"":"none",e.debug_writeValues(i),t.addEventListener("change",(()=>{const i=t.checked;s.style.display=i?"":"none",e.debug_writeValues(i),localStorage.setItem("showDebug",i?"true":"false")}))}}var c;!function(e){e[e.NotStarted=0]="NotStarted",e[e.Running=1]="Running",e[e.Paused=2]="Paused",e[e.Ended=3]="Ended"}(c||(c={}));class d{constructor(){var e;this._gameTimer=0,this._gameState=c.NotStarted,this.playerClassRegistry={Assassin:s,Mage:a,Paladin:l,Warrior:n},null===(e=document.getElementById("resetButton"))||void 0===e||e.addEventListener("click",(()=>this.resetGame())),this._gameSettings=this.initializeGameSettings(),this.populateSettingsUIFromGameSettings(),window.addEventListener("beforeunload",(()=>{this._gameState!==c.Ended&&o.saveGame()}))}static getInstance(){return d.instance||(d.instance=new d),d.instance}set board(e){this._board=e}get board(){if(!this._board)throw new Error("Board was not initialized!");return this._board}set player(e){this._player=e}get player(){if(!this._player)throw new Error("Player was not initialized!");return this._player}get timer(){if(this._timer)return this._timer}get invertClicks(){return this._gameSettings.invertClicks}get removeFlags(){return this._gameSettings.removeFlags}createBoard(){this.board=new h(this._gameSettings.width,this._gameSettings.height,this._gameSettings.minesFrequency,this)}createPlayer(){const e=this.playerClassRegistry[this._gameSettings.playerClass];if(e)if("Mage"===this._gameSettings.playerClass){if(!this._board)throw new Error("Board must be initialized before creating a Mage player.");this.player=new e(this._board)}else this.player=new e(void 0);else console.error(`Unknown player class: ${this._gameSettings.playerClass}. Defaulting to Warrior.`),this.player=new n(void 0)}loadDefaultSettings(){return{width:e.boardDefaults.width,height:e.boardDefaults.height,minesFrequency:e.boardDefaults.minesFrequency,playerClass:e.playerClass,invertClicks:e.boardDefaults.invertClicks,removeFlags:e.boardDefaults.removeFlags}}initializeGameSettings(){const e=this.loadDefaultSettings(),t=localStorage.getItem("instance");if(t)try{const s=JSON.parse(t);return Object.assign(Object.assign(Object.assign({},e),s),{width:void 0!==s.width?+s.width:e.width,height:void 0!==s.height?+s.height:e.height,minesFrequency:void 0!==s.minesFrequency?+s.minesFrequency:e.minesFrequency,playerClass:s.playerClass||e.playerClass,invertClicks:"boolean"==typeof s.invertClicks?s.invertClicks:e.invertClicks,removeFlags:"boolean"==typeof s.removeFlags?s.removeFlags:e.removeFlags})}catch(t){return console.error("Failed to parse stored settings, using defaults and removing corrupted item.",t),localStorage.removeItem("instance"),e}return e}playerUp(){this.board.indicateLevelGain(this.player.level),this.board.evoluteMonster(),this._gameSettings.removeFlags&&this.board.removeAllFlags(),"Mage"===this.player.className&&this.player.resetFireball()}resetGame(){this._gameState!==c.Running&&this._gameState!==c.Paused||this.stopTimer(),this._board&&this._board.removeEventHandler(),this._gameState=c.NotStarted;const e=document.getElementById("app");e&&(e.innerHTML=""),this.resetHeartContainer(),this.startGame(),M()}saveSettingsFromUI(){try{this._gameSettings.width=+this.getValueFromInput("inputWidth"),this._gameSettings.height=+this.getValueFromInput("inputHeight"),this._gameSettings.minesFrequency=+this.getValueFromInput("minesFrequency"),this._gameSettings.playerClass=this.getValueFromInput("selectClass"),this._gameSettings.invertClicks=this.getCheckedFromToggle("invertClicks"),this._gameSettings.removeFlags=this.getCheckedFromToggle("removeFlags"),localStorage.setItem("instance",JSON.stringify(this._gameSettings))}catch(e){console.error("Error saving settings from UI:",e)}}startGame(){var e;this._gameState!==c.Running&&(document.getElementById("modal")&&this.saveSettingsFromUI(),document.getElementById("modal")&&this.getScores(),this.createBoard(),this.createPlayer(),null===(e=this._board)||void 0===e||e.openStartArea(),this.resetTimer(),this._timer=setInterval((()=>this.countSeconds()),1e3),this._gameState=c.Running,o.isGameEnded=!1)}winGame(){this.endGame(),this.updateLeaderboard(this.player.score),this.displayLeaderboard(`You won! Score: ${this.player.score}`)}loseGame(){this.endGame(),this.displayLeaderboard("You lost!")}pauseTimer(){this._timer&&this._gameState===c.Running&&(clearInterval(this._timer),this._timer=void 0,this._gameState=c.Paused)}resumeTimer(){this._gameState===c.Paused&&(this._timer=setInterval((()=>this.countSeconds()),1e3),this._gameState=c.Running)}updateLeaderboard(e){const t="leaderboard",s=JSON.parse(localStorage.getItem(t)||"[]");s.push(e),s.sort(((e,t)=>t-e));const i=s.slice(0,10);localStorage.setItem(t,JSON.stringify(i))}getScores(){return JSON.parse(localStorage.getItem("leaderboard")||"[]")}displayLeaderboard(e){b(e)}isGameEnded(){return this._gameState===c.Ended}createMemento(){return{board:this.board.createMemento(),player:this.player.createMemento(),gameTimer:this._gameTimer,gameSettings:this._gameSettings}}restoreFromMemento(e){this._gameSettings=e.gameSettings,this.populateSettingsUIFromGameSettings(),this.createBoard(),this.createPlayer(),this.board.restoreFromMemento(e.board),this.player.restoreFromMemento(e.player),this._gameTimer=e.gameTimer,this._gameState=c.Paused,this.resumeTimer()}countSeconds(){this._gameTimer++,this.player.calculateScore(this._gameTimer)}endGame(){this._gameState!==c.Ended&&(this.stopTimer(),this._gameState=c.Ended,this.board.revealBoard(),o.deleteSave())}getValueFromInput(e){const t=document.getElementById(e);if(t)return t.value;throw new Error(`HTML input element with id '${e}' not found.`)}getCheckedFromToggle(e){const t=document.getElementById(e);if(t)return t.checked;throw new Error(`HTML input (checkbox/toggle) element with id '${e}' not found.`)}populateSettingsUIFromGameSettings(){this.trySetInputValue("inputWidth",this._gameSettings.width.toString()),this.trySetInputValue("inputHeight",this._gameSettings.height.toString()),this.trySetInputValue("minesFrequency",this._gameSettings.minesFrequency.toString()),this.trySetInputValue("selectClass",this._gameSettings.playerClass),this.trySetToggleValue("invertClicks",this._gameSettings.invertClicks),this.trySetToggleValue("removeFlags",this._gameSettings.removeFlags)}trySetInputValue(e,t){const s=document.getElementById(e);s?s.value=t:console.warn(`HTML input element with id '${e}' not found for setting value.`)}trySetToggleValue(e,t){const s=document.getElementById(e);s?s.checked=t:console.warn(`HTML input (checkbox/toggle) element with id '${e}' not found for setting value.`)}resetTimer(){this.stopTimer(),this._gameTimer=0}stopTimer(){clearInterval(this._timer)}resetHeartContainer(){const e=document.getElementById("health");e&&(e.innerHTML="")}}class m{constructor(t,s){this.modalSettings={cancelButton:!1,confirmButton:!0,showClass:!0,showClassDescription:!0,showSlot:!0,showSubTitle:!0},this.parentNode=t,this.modalSettings=Object.assign(Object.assign({},this.modalSettings),s);const i=document.getElementById("template-modal");if(!i)throw new Error("No modal-template found");this.node=i.content.cloneNode(!0),this.node=t.appendChild(this.node),this.setCancelAction(),this.parseModalSettings(),this.setClassTitle(e.playerClass),this.addEventListener()}destroyModal(){var e;null===(e=document.getElementById("modal-bg"))||void 0===e||e.remove()}parseModalSettings(){var e,t,s,i,a,l;this.modalSettings.cancelButton||null===(e=document.getElementById("modal-cancel"))||void 0===e||e.remove(),this.modalSettings.confirmButton||null===(t=document.getElementById("modal-confirm"))||void 0===t||t.remove(),this.modalSettings.title&&this.setTitle(this.modalSettings.title),this.modalSettings.subtitle&&this.setSubTitle(this.modalSettings.subtitle),this.modalSettings.text&&this.setText(this.modalSettings.text),this.modalSettings.showClass||null===(s=document.getElementById("modal-class"))||void 0===s||s.remove(),this.modalSettings.showClassDescription||null===(i=document.getElementById("modal-classDescription"))||void 0===i||i.remove(),this.modalSettings.showSlot||null===(a=document.getElementById("modal-slot"))||void 0===a||a.remove(),this.modalSettings.showSubTitle||null===(l=document.getElementById("modal-subtitle"))||void 0===l||l.remove()}setSubTitle(e){const t=document.getElementById("modal-subtitle");t&&(t.innerText=e)}setTitle(e){const t=document.getElementById("modal-title");t&&(t.innerText=e)}setClassTitle(e){const t=document.getElementById("modal-class");t&&(t.innerText=e,this.setClassText(e))}setClassText(e){const t=document.getElementById("modal-classDescription");if(t)switch(e){case"Assassin":t.innerText="The assassin can kill Monster on his Level \n‚Ä¢ Right click on a monster on the same level to kill it without taking damage \n‚Ä¢ Right click on a lower level monster will give you 1 damage \n‚Ä¢ Opening an area with right click will give you 1 damage when the area contains a monster on the same level or higher";break;case"Warrior":t.innerText="The warrior gains hearts on level up";break;case"Paladin":t.innerText="The paladin has high health to begin with";break;case"Mage":t.innerText="The mage can throw fire balls"}}setSlotContent(e){const t=document.getElementById("modal-slot");t&&(t.innerHTML=e)}setText(e){const t=document.getElementById("modal-text");t&&(t.innerText=e)}setLeaderboardContent(e){const t=document.getElementById("modal-leaderboard");t&&(e=e.slice(0,10)).forEach((e=>{const s=document.createElement("li");s.innerText=e.toString(),t.appendChild(s)}))}setDefaultClass(){const t=this.getStoredPlayerClass()||e.playerClass,s=document.getElementById("selectClass");s&&(s.value=t,this.setClassTitle(t),this.setClassText(t))}getStoredPlayerClass(){let t=e.playerClass;const s=localStorage.getItem("instance");if(s)try{const e=JSON.parse(s);e.playerClass&&(t=e.playerClass)}catch(e){}return t}setConfirmAction(e){const t=document.getElementById("modal-confirm");t&&t.addEventListener("click",(()=>{e(),this.destroyModal()}))}setCancelAction(e){const t=document.getElementById("modal-cancel");t&&t.addEventListener("click",(()=>{e&&e(),this.destroyModal()}))}addEventListener(){new MutationObserver(((e,t)=>{const s=document.getElementById("selectClass");s&&(s.addEventListener("change",(()=>this.setClassTitle(s.value))),t.disconnect())})).observe(document.body,{childList:!0,subtree:!0})}setConfirmButtonText(e){const t=document.getElementById("modal-confirm");t&&(t.innerText=e)}setCancelButtonText(e){const t=document.getElementById("modal-cancel");t&&(t.innerText=e)}setSecondaryConfirmButtonText(e){const t=document.getElementById("modal-secondary-confirm");t&&(t.innerText=e,t.style.display="inline-block")}setSecondaryConfirmAction(e){const t=document.getElementById("modal-secondary-confirm");t&&t.addEventListener("click",(()=>{e(),this.destroyModal()}))}}const g={STORAGE_KEY:"theme-preference",getCurrentTheme(){const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e).theme:"system"},getSystemTheme:()=>window.matchMedia("(prefers-color-scheme: dark)").matches,setTheme(e){const t={theme:e,systemDark:this.getSystemTheme()};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(t)),this.applyTheme()},applyTheme(){const e=this.getCurrentTheme(),t="system"===e?this.getSystemTheme():"dark"===e;document.documentElement.classList.toggle("dark",t)},initialize(){this.applyTheme(),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",(()=>{"system"===this.getCurrentTheme()&&this.applyTheme()}))}},u=d.getInstance(),p=document.getElementById("template-settings"),y=document.getElementById("menu"),v=document.getElementById("template-leaderboard");function f(e,t,s,i){const a=document.getElementById(e);null==a||a.addEventListener(t,s,i)}function S(){!function(e,t="flex"){e&&(e.style.display=t)}(y)}function b(e=""){T(v,"No leaderboard template found"),E(y),u.pauseTimer();const t=new m(document.body,{cancelButton:!0,confirmButton:!1,showSubTitle:!0,showClass:!1,showClassDescription:!1,showSlot:!1});t.setTitle("Leaderboard"),t.setSubTitle(e),t.setText("These are your best scores"),t.setLeaderboardContent(u.getScores()),t.setCancelAction((()=>{u.resumeTimer(),E(y)}))}function E(e,t="flex"){e&&(e.style.display=e.style.display===t?"none":t)}function C(){const e=document.getElementById("themeSelect");if(!e)return;const t=e;t.value=g.getCurrentTheme(),t.onchange=()=>g.setTheme(t.value)}function T(e,t){if(!e)throw new Error(t)}function M(){const e=document.getElementById("fireball");if(!e)return;const t=(t,s)=>{t?e.classList.add("fireball-waiting"):e.classList.remove("fireball-waiting"),s?e.classList.add("fireball-ready"):e.classList.remove("fireball-ready")},s=u.player;if("Mage"===s.className){const i=s;e.style.display="",i.isFireballModeActive?t(!0,!1):i.canCastFireball()?t(!1,!0):t(!1,!1)}else e.style.display="none",t(!1,!1)}var w;g.initialize(),C(),function(){const e=document.getElementById("fireball");if(!e)return;e.addEventListener("click",(e=>{if(e.preventDefault(),e.stopPropagation(),"Mage"!==u.player.className)return;const t=u.player;t.isFireballModeActive?t.deactivateFireballMode():t.activateFireballMode()||console.log("Fireball not ready or player cannot cast.")}))}(),function(){T(p,"No settings template found");const e=new m(document.body,{cancelButton:!1});e.setTitle("New Game"),e.setSubTitle("Welcome to DungeonSweeper"),e.setText("This is a more elaborate version of MineSweeper with RPG elements such as classes, leveling and different enemies. Please choose your starting configuration."),e.setSlotContent(p.innerHTML),e.setConfirmButtonText("New Game"),e.setConfirmAction((()=>{S(),u.resetGame()})),o.hasSave()&&(e.setConfirmButtonText("New Game"),e.setConfirmAction((()=>{o.deleteSave(),S(),u.resetGame()})),e.setSecondaryConfirmButtonText("Continue"),e.setSecondaryConfirmAction((()=>{const e=o.loadGame();e&&(u.restoreFromMemento(e),u.player.updateStatsheet(),u.board.redraw(),S())}))),e.setDefaultClass(),C(),u.populateSettingsUIFromGameSettings();const t=document.getElementById("modal-debug");t&&t.remove()}(),u.populateSettingsUIFromGameSettings(),(w=y)&&(w.style.display="none"),f("openSettings","click",(function(){T(p,"No settings template found");const e=new m(document.body,{cancelButton:!0});e.setTitle("Game Settings"),e.setText("Please choose the settings for your next round"),e.setSlotContent(p.innerHTML),e.setConfirmAction((()=>{u.resetGame(),E(y)})),e.setCancelAction((()=>E(y))),e.setDefaultClass(),E(y),C(),u.populateSettingsUIFromGameSettings();try{u.board.setupDebugUI()}catch(e){}})),f("reset","click",(()=>u.resetGame())),f("openLeaderboard","click",(()=>b())),f("debugLevelUp","click",(()=>u.player.debugGainLevel())),window.gameInstance=d.getInstance()})();